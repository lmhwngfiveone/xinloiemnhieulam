<script>
  const SECRET_PASSWORD = "H·ªìng Th∆°m";
  const FORMSPREE_ENDPOINT = "https://formspree.io/f/mldoyogr"; // üîó Formspree c·ªßa b·∫°n

  let currentQuestion = 0;
  const questions = document.querySelectorAll('.question');
  const introScreen = document.getElementById('intro-screen');
  const questionsContainer = document.getElementById('questions-container');
  const apologyMessageScreen = document.getElementById('apology-message-screen');
  const answers = [];

  function recordAnswer(question, answer) {
    answers.push({ question, answer });
  }

  function nextQuestion() {
    // ·∫®n m√†n h√¨nh hi·ªán t·∫°i
    if (currentQuestion === 0) {
      introScreen.classList.add('hidden');
      questionsContainer.classList.remove('hidden');
    } else {
      const prevQuestion = questions[currentQuestion - 1];
      prevQuestion.classList.add('hidden');

      // L∆∞u c√¢u tr·∫£ l·ªùi
      const h2 = prevQuestion.querySelector('h2');
      const textarea = prevQuestion.querySelector('textarea');
      const selected = prevQuestion.querySelector('button.selected');
      let answer = "";

      if (textarea) answer = textarea.value.trim();
      else if (selected) answer = selected.innerText;

      if (answer) recordAnswer(h2 ? h2.innerText : "Kh√¥ng r√µ c√¢u h·ªèi", answer);
    }

    // Hi·ªÉn th·ªã c√¢u h·ªèi ti·∫øp theo
    if (currentQuestion < questions.length) {
      questions[currentQuestion].classList.remove('hidden');
      currentQuestion++;
    }
  }

  // Khi ng∆∞·ªùi d√πng ch·ªçn n√∫t (‚ù§Ô∏è, C√≥ üò°,‚Ä¶)
  document.querySelectorAll('.question button').forEach(btn => {
    btn.addEventListener('click', e => {
      e.target.parentElement.querySelectorAll('button').forEach(b => b.classList.remove('selected'));
      e.target.classList.add('selected');
    });
  });

  async function sendAllToFormspree() {
    const data = {
      answers: answers,
      sent_at: new Date().toLocaleString()
    };

    console.log("üì§ G·ª≠i l√™n Formspree:", data);

    try {
      const response = await fetch(FORMSPREE_ENDPOINT, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Accept": "application/json"
        },
        body: JSON.stringify(data)
      });

      if (response.ok) console.log("‚úÖ G·ª≠i th√†nh c√¥ng:", data);
      else console.error("‚ö†Ô∏è G·ª≠i th·∫•t b·∫°i:", response.statusText);
    } catch (error) {
      console.error("‚ùå L·ªói m·∫°ng:", error);
    }
  }

  function checkPassword() {
    const passwordInput = document.getElementById('password-input');
    const feedbackMessage = document.getElementById('feedback-message');
    const input = passwordInput.value.trim();

    recordAnswer("M·∫≠t kh·∫©u m·ªü l·ªùi xin l·ªói", input);

    if (input.toLowerCase() === SECRET_PASSWORD.toLowerCase()) {
      questionsContainer.classList.add('hidden');
      apologyMessageScreen.classList.remove('hidden');

      recordAnswer("K·∫øt qu·∫£ m·ªü kh√≥a", "‚úÖ Nh·∫≠p ƒë√∫ng m·∫≠t kh·∫©u");

      // üì® G·ª≠i d·ªØ li·ªáu l√™n Formspree
      sendAllToFormspree();
    } else {
      feedbackMessage.textContent = "Sai m·∫≠t kh·∫©u r·ªìi, em th·ª≠ l·∫°i nh√©!";
      feedbackMessage.classList.remove('hidden');
      feedbackMessage.classList.remove('text-green-600');
      feedbackMessage.classList.add('text-red-600');

      recordAnswer("K·∫øt qu·∫£ m·ªü kh√≥a", "‚ùå Sai m·∫≠t kh·∫©u");
    }
  }
</script>
